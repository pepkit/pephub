{% extends "base.html" %}
{% block content %}
<div>
    <div class="flex-row d-flex align-items-start justify-content-between">
      <h1 id="namespace-header" class="fw-bold">{{namespace.namespace}}</h1>
      <div>
        <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#apiEndpoints">
          <i class="bi bi-hdd-rack"></i>
          API Endpoints
        </button>
        {% if can_edit %}
        <button class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#newProject">
          <i class="bi bi-plus-circle"></i>
          Add PEP
        </button>
        {% endif %}
      </div>
    </div>
    <p class="mb-0"><span class="fw-bold">Total projects:</span> {{namespace.number_of_projects}}</p>
    <p class="mb-0"><span class="fw-bold">Total samples:</span> {{namespace.number_of_samples}}</p>
    <div class="my-2 border-bottom border-secondary"></div>
    <div class="my-2">
      <!-- Search bar -->
      <div class="flex-row d-flex align-items-center" style="position: relative;">
        <div class="mb-3 input-group">
          <span id="search-bar-label" class="input-group-text" id="search-addon">
            Search
          </span>
          <input id="search-bar" onkeyup="handleSearchDebounced()" type="text" class="form-control" placeholder="Search for PEPs in {{namespace.namespace}}" aria-label="search" aria-describedby="search-addon">
        </div>
      </div>
      <!-- Search results -->
      <div id="search-results">
        <div class="flex-row d-flex align-items-center justify-content-center">
          <div class="spinner-border text-secondary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <span class="ms-3 text-secondary">
            <em>Fetching PEPs</em>
          </span>
        </div>
      </div>
    </div>
    <!-- Delete PEP confiration Modal -->
    <div class="modal" id="deletePEP" tabindex="-1" aria-labelledby="deletePEPModal" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="deletePEPModal">Delete PEP?</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>Are you sure you want to delete this PEP? This action cannot be undone.</p>
            <label class="mb-3">
              Please type <span class="fw-bold" id="delete-pep-name"></span> to confirm:
            </label>
            <input onkeyup="handleDeleteInputChange()" id="delete-confirm-input" type="text" class="form-control">
          </div>
          <div class="modal-footer">
            <button disabled onclick="deleteProject()" type="button" class="btn btn-danger">Yes, delete</button>
          </div>
        </div>
      </div>
    </div>
    <!-- API Endpoints Modal -->
    <div class="modal" id="apiEndpoints" tabindex="-1" aria-labelledby="apiEndpointsModal" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="apiEndpointsModal">API Endpoints Available</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p class="mb-2">
              <span class="badge bg-primary">GET</span>
              <span class="fw-bold">Namespace:</span>
              <code>
                <a href="/api/v1/namespaces/{{namespace.namespace}}/">
                  /api/v1/namespaces/{{namespace.namespace}}/
                </a>
              </code>
          </p>
          <p class="mb-2">
            <span class="badge bg-primary">GET</span>
            <span class="fw-bold">Namespace:</span>
            <code>
              <a href="/api/v1/namespaces/{{namespace.namespace}}/projects">
                /api/v1/namespaces/{{namespace.namespace}}/projects
              </a>
            </code>
          </p>
          </div>
        </div>
      </div>
    </div>
    <!-- Submit PEP modal (DRAG-N-DROP) -->
    <div class="modal" id="newProject" tabindex="-1" aria-labelledby="newProjectModal" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5">Submit a new PEP</h1> 
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <nav>
              <div class="nav nav-tabs" id="nav-tab" role="tablist">
                <button class="nav-link active" id="submit-modal-nav-upload-tab" data-bs-toggle="tab" data-bs-target="#nav-upload" type="button" role="tab" aria-controls="nav-upload" aria-selected="true">
                  <i class="bi bi-cloud-upload"></i>
                  Upload
                </button>
                <button class="nav-link" id="submit-modal-nav-blank-tab" data-bs-toggle="tab" data-bs-target="#nav-blank" type="button" role="tab" aria-controls="nav-blank" aria-selected="false">
                  <i class="bi bi-pencil"></i>
                  New
                </button>
              </div>
            </nav>
            <div class="tab-content" id="nav-tabContent">
              <!-- UPLOAD FORM -->
              <div class="tab-pane show active" id="nav-upload" role="tabpanel" aria-labelledby="submit-modal-nav-upload-tab">
                <div class="rounded-bottom border border-top-0">
                  <form id="new-project-form" action="/api/v1/namespaces/{{namespace.namespace}}/projects" class="border-0 form-control" method="post" enctype="multipart/form-data">
                    <div class="mb-3 form-check form-switch">
                      <input value="true" name="is_private" class="form-check-input" type="checkbox" role="switch" id="is-private-toggle"  />
                      <label class="form-check-label" for="flexSwitchCheckDefault">
                        <i class="bi bi-lock"></i>
                        Private
                      </label>
                    </div>
                    <span class="fs-4 d-flex align-items-center">
                      <select name="namespace" id="namespace-select" class="form-select w-75" aria-label="Namespace selection" class="mb-1">
                        <option value="{{namespace.namespace}}">{{namespace.namespace}}</option>
                        {% for org in orgs %}
                          <option value="{{org}}">{{org}}</option>
                        {% endfor %}
                      </select>
                      <span class="mx-1 mb-1">/</span>
                      <input id="project-name" name="project_name" type="text" class="form-control" placeholder="name" />
                      <span class="mx-1 mb-1">:</span>
                      <input id="tag" name="tag" type="text" class="form-control" placeholder="default" />
                    </span>
                    <div 
                      id="dnd-box"
                      onclick="clickFileInput()"
                      class="p-5 mt-3 border border-2 d-flex flex-column align-items-center justify-content-center rounded-3" 
                      ondragover="allowDrop(event)" 
                    >
                        <div class="flex-row d-flex align-items-center">
                          <i class="bi bi-cloud-arrow-up"></i>
                          <span class="text-secondary ms-2">Drag files here</span>
                        </div>
                        <span class="my-1 text-secondary">or</span>
                        <span class="text-secondary">click to browse</span>
                    </div>
                    <div 
                      id="file-list-container" 
                      style="border-style: dashed !important;" 
                      class="p-5 mt-3 border border-2 d-none d-flex flex-column align-items-center justify-content-center rounded-3"
                    >
                      <div id="file-list"></div>
                      <div class="mt-3">
                        <button type="button" onclick="clickFileInput()" class="btn btn-sm btn-outline-dark">
                          <i class="bi bi-archive"></i>
                          Browse
                        </button>
                        <button type="button" onclick="handleClearFileInput()" class="btn btn-sm btn-outline-dark">
                          <i class="bi bi-x"></i>
                          Clear
                        </button>
                      </div>
                    </div>
                    <input hidden multiple type="file" id="files" name="files"/>
                    <div class="mt-3">
                      <button 
                        id="new-project-submit-btn" 
                        class="btn btn-success" 
                        type="submit"
                        disabled
                      >
                        <i class="bi bi-plus-circle"></i>
                        Add
                      </button>
                      <button
                        type="button"
                        class="btn btn-outline-dark"
                        data-bs-dismiss="modal"
                        onclick="resetForm()"
                      >
                        Cancel
                      </button>
                    </div>
                  </form>
                </div>
              </div>
              <!-- BLANK PEP -->
              <div class="tab-pane" id="nav-blank" role="tabpanel" aria-labelledby="submit-modal-nav-blank-tab">
                <div class="rounded-bottom border border-top-0">
                  <form id="blank-project-form" class="border-0 form-control">
                    <div class="mb-3 form-check form-switch">
                      <input value="true" name="blank_is_private" class="form-check-input" type="checkbox" role="switch" id="blank-is-private-toggle"  />
                      <label class="form-check-label" for="flexSwitchCheckDefault">
                        <i class="bi bi-lock"></i>
                        Private
                      </label>
                    </div>
                    <span class="fs-4 d-flex align-items-center">
                      <select name="blank_namespace" id="blank-namespace-select" class="form-select w-75" aria-label="Namespace selection" class="mb-1">
                        <option value="{{namespace.namespace}}">{{namespace.namespace}}</option>
                        {% for org in orgs %}
                          <option value="{{org}}">{{org}}</option>
                        {% endfor %}
                      </select>
                      <span class="mx-1 mb-1">/</span>
                      <input id="blank-project-name" name="blank_project_name" type="text" class="form-control" placeholder="name" />
                      <span class="mx-1 mb-1">:</span>
                      <input id="blank_tag" name="blank_tag" type="text" class="form-control" placeholder="default" />
                    </span>
                    <textarea id="blank_description" name="blank_description" class="form-control mt-3" rows="3" placeholder="Describe your PEP."></textarea>
                    <div class="mt-3">
                      <button 
                        id="blank-project-submit-btn" 
                        class="btn btn-success" 
                        type="submit"
                        disabled
                      >
                        <i class="bi bi-plus-circle"></i>
                        Add
                      </button>
                      <button
                        type="button"
                        class="btn btn-outline-dark"
                        data-bs-dismiss="modal"
                        onclick="resetBlankForm()"
                      >
                        Cancel
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>            
          </div>
        </div>
      </div>
    </div>
    <!-- Successful project creation toast-->
    <div class="top-0 p-3 toast-container position-absolute end-0" id="toastPlacement">
      <div id="new-project-success-toast" class="text-white toast bg-success" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
          <strong class="me-auto">Success!</strong>
          <small>Just now</small>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
          New project <span class="fw-bold" id="project-name-toast-success"></span>, created successfully!
        </div>
      </div>
    <!-- Error during creation toast-->
      <div id="new-project-error-toast" class="toast bg-danger" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
          <strong class="me-auto">Error!</strong>
          <small>Just now</small>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
          There was an error creating the project:
          <div id="new-project-creation-error-message"></div>
        </div>
      </div>
    <!-- Successful delete toast -->
        <div id="project-delete-toast-success" class="text-white toast bg-success" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="toast-header">
            <strong class="me-auto">Success!</strong>
            <small>Just now</small>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
          <div class="toast-body">
            Successfully deleted <span class="fw-bold" id="project-delete-name-toast-success"></span>
          </div>
        </div>
    </div>
</div>
  <!-- Custom JavaScript -->
  <script src="/static/js/namespace.js"></script>
  <script src="/static/js/project_upload.js"></script>

  <!-- DataTabes-->
  <script src="https://cdn.jsdelivr.net/npm/simple-datatables@latest"></script>

  <!-- Drag n Drop files -->
  <style>
    #dnd-box {
      border-style: dashed !important;
    }
    #dnd-box:hover {
      cursor: pointer;
    }
  </style>
  <script>

    const handleClearFileInput = () => {
      clearFileInput()
      onFormChange()
    }

    // hover effects for drag and drop box
    const dragAndDrop = document.getElementById("dnd-box");
    dragAndDrop.addEventListener("mouseenter", function() {
      dragAndDrop.classList.add("bg-light");
    });
    dragAndDrop.addEventListener("mouseleave", function() {
      dragAndDrop.classList.remove("bg-light");
    });

    // event listener for drag and drop
    const dropZone = document.getElementById("dnd-box");
    dropZone.addEventListener("drop", handleDrop);

    // event listener to render file names on input change
    fileInput = document.getElementById("files");

    // mount handler
    fileInput.addEventListener("change", onFileInputChange);
    fileInput.addEventListener("change", onFormChange);

    // submit button things
    const submitButton = document.getElementById("new-project-submit-btn");
    submitButton.addEventListener("click", submitNewProject);


</script>

<!--assign to table -->
<script>
  const table = new simpleDatatables.DataTable("#namespace-table")
</script>

<!-- Attach the event handlers to the submission form -->
<script>
  const form = document.getElementById("new-project-form")
  form.addEventListener("submit", submitNewProject, true);

  // on change handler for entire form to enable/disable submit button
  form.addEventListener("change", onFormChange);

  // attach same event handler to project-name input
  const projectNameInput = document.getElementById("project-name");
  projectNameInput.addEventListener("keyup", onFormChange);

  // on change handler for the blank submission form
  const blankForm = document.getElementById("blank-project-form")
  blankForm.addEventListener("change", onBlankFormChange);

  // attach same event handler to blank-project-name input
  const blankProjectNameInput = document.getElementById("blank-project-name");
  blankProjectNameInput.addEventListener("keyup", onBlankFormChange);

</script>

<!-- Fetch projects on page load. -->
<script>
  fetchProjectsInNamespace(
    document.getElementById("namespace-header").innerText
  )
</script>
{% endblock %}