{% extends "base.html" %}
{% block content %}
<div>
  <div class="mb-3">
    <a id="back-link" href="/{{ namespace }}/{{ project.name }}">
      <button class="btn btn-sm btn-outline-primary">
        <i class="bi bi-arrow-bar-left"></i>
        Back to project
      </button>
    </a>
  </div>
  <ul class="nav nav-tabs" id="editTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="metadata-tab" data-bs-toggle="tab" data-bs-target="#metadata" type="button" role="tab" aria-controls="metadata" aria-selected="true">
        Metadata
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="project-config-tab" data-bs-toggle="tab" data-bs-target="#project-config" type="button" role="tab" aria-controls="project-config" aria-selected="false">
        Project Config
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="samples-tab" data-bs-toggle="tab" data-bs-target="#samples" type="button" role="tab" aria-controls="samples" aria-selected="false">
        Sample Table
      </button>
    </li>
  </ul>
  <div class="tab-content border-start border-end border-bottom h-75" id="editTabsContent">
    <div class="tab-pane show active" id="metadata" role="tabpanel" aria-labelledby="metadata-tab">
      <div class="p-2">
        <form id="metadata-form" action="/api/v1/projects/{{namespace}}/{{project}}" method="PATCH">
          <div class="form-check form-switch mb-3">
            <label class="form-check-label" for="is-private-toggle">Private</label>
            <input value="{{is_private}}" class="form-check-input" type="checkbox" role="switch" id="is-private-toggle">
          </div>
          <div class="mb-3">
            <label for="project-name" class="form-label">Project Name</label>
            <input onkeyup="detectMetadataChanges()" value="{{project.name}}" placeholder="{{ project.name }}" type="text" class="form-control" id="project-name" aria-describedby="pep-name-help">
            <div id="pep-name-help" class="form-text">Rename your PEP.</div>
          </div>
          <div class="mb-3">
            <label for="project-description" class="form-label">Project Description</label>
            <textarea onkeyup="detectMetadataChanges()" value="{{description}}" placeholder="{{ description }}" class="form-control" id="project-description" rows="3"></textarea>
          </div>
          <button onclick="cancelChanges()" type="button" class="btn btn-outline-secondary">
            Cancel
          </button>
          <button onclick="handleMetaMetaDataSubmit('{{ namespace }}', '{{ project.name}}')" id="metadata-save-btn" disabled type="button" disabled class="btn btn-success">
            Save
          </button>
        </form>
      </div>
    </div>
    <div class="tab-pane" id="project-config" role="tabpanel" aria-labelledby="project-config-tab">
      <div class="p-2" id="yaml-component">
        <div id="yaml-editor-div" style="height:400px"></div>
        <div class="d-flex flex-row align-items-center justify-content-start">
          <button onclick="getProjectConfigYamlFromDatabase()" class="btn btn-outline-secondary me-1">
            Cancel
          </button>
          <button onclick="handleProjectConfigYamlSubmit()" id="yaml-save-btn" disabled class="btn btn-success me-1">
            Save
          </button>
        </div>
      </div>
    </div>
    <div class="tab-pane" id="samples" role="tabpanel" aria-labelledby="samples-tab">
      <div onkeyup="detectSampleTableChanges()" id="csv-component" class="p-1">
        <div class="mb-1 d-flex flex-row align-items-center justify-content-between">
          <div>
            <div class="dropdown">
              <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false">
                Edit
              </button>
              <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
                <li onclick="addRow()">
                  <a class="dropdown-item text-success">
                    <i class="bi bi-plus-circle"></i>
                    Add row
                  </a>
                </li>
                <li onclick="addCol()">
                  <a class="dropdown-item text-success">
                    <i class="bi bi-plus-circle"></i>
                    Add column
                  </a>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li onclick="removeRow()">
                  <a class="dropdown-item text-danger">
                    <i class="bi bi-dash-circle"></i>
                    Remove Row
                  </a>
                </li>
                <li onclick="removeCol()">
                  <a class="dropdown-item text-danger">
                    <i class="bi bi-dash-circle"></i>
                    Remove Col
                  </a>
                </li>
              </ul>
            </div>
          </div>
          <div>
            <button onclick="getSampleTableFromDatabase()" type="button" class="btn btn-sm btn-outline-secondary">
              Cancel
            </button>
            <button onclick="handleSampleTableEditorSubmit()" id="sample-table-save-btn" disabled type="button" class="btn btn-sm btn-success">
              Save
            </button>
          </div>
        </div>
        <div id="csv-editor-div"></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block tail %}
<!-- Custom JavaScript -->
<script src="/static/js/edit_project.js"></script>
<script src="/static/js/utils.js"></script>

<!-- meta meta data helpers -->
<script>
  // attach event listener to meta meta data form
  const form = document.getElementById("metadata-form")
  form.addEventListener("change", detectMetadataChanges)

</script>

<!-- hands on table-->
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css" />

<!-- papa parse -->
<script 
  src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js" 
  integrity="sha512-SGWgwwRA8xZgEoKiex3UubkSkV1zSE1BS6O4pXcaxcNtUlQsOmOmhVnDwIvqGRfEmuz83tIGL13cXMZn6upPyg==" 
  crossorigin="anonymous" 
  referrerpolicy="no-referrer"
></script>

<!-- monaco editor -->
<script>var require = { paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.26.1/min/vs' } }</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.26.1/min/vs/loader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.26.1/min/vs/editor/editor.main.nls.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.26.1/min/vs/editor/editor.main.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.26.1/min/vs/basic-languages/yaml/yaml.js"></script>

<script>
  
  loadHandsOnTable()
  loadYAMLEditor()
  
  // get project config yaml from database
  getProjectConfigYamlFromDatabase()

  // get sample table from database
  getSampleTableFromDatabase()

  // get meta meta data from database
  getMetaMetaDataFromDatabase()
</script>
{% endblock %}