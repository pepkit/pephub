{% extends "base.html" %}
{% block content %}
<div>
  <div class="mb-3">
    <a href="/{{ namespace }}/{{ project.name }}">
      <button class="btn btn-sm btn-outline-primary">
        <i class="bi bi-arrow-bar-left"></i>
        Back to project
      </button>
    </a>
  </div>
  <ul class="nav nav-tabs" id="editTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="metadata-tab" data-bs-toggle="tab" data-bs-target="#metadata" type="button" role="tab" aria-controls="metadata" aria-selected="true">
        Metadata
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button onclick="loadYAMLEditor()" class="nav-link" id="project-config-tab" data-bs-toggle="tab" data-bs-target="#project-config" type="button" role="tab" aria-controls="project-config" aria-selected="false">
        Project Config
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button onclick="loadCSVEditor()" class="nav-link" id="samples-tab" data-bs-toggle="tab" data-bs-target="#samples" type="button" role="tab" aria-controls="samples" aria-selected="false">
        Sample Table
      </button>
    </li>
  </ul>
  <div class="tab-content border-start border-end border-bottom h-75" id="editTabsContent">
    <div class="tab-pane fade show active" id="metadata" role="tabpanel" aria-labelledby="metadata-tab">
      <div class="p-2">
        <form id="metadata-form">
          <div class="form-check form-switch mb-3">
            <label class="form-check-label" for="is-private-toggle">Private</label>
            <input value="{{is_private}}" class="form-check-input" type="checkbox" role="switch" id="is-private-toggle">
          </div>
          <div class="mb-3">
            <label for="project-name" class="form-label">Project Name</label>
            <input onkeyup="detectMetadataChanges()" value="{{project.name}}" placeholder="{{ project.name }}" type="text" class="form-control" id="project-name" aria-describedby="pep-name-help">
          <div id="pep-name-help" class="form-text">Rename your PEP.</div>
          </div>
          <div class="mb-3">
            <label for="project-description" class="form-label">Project Description</label>
            <textarea onkeyup="detectMetadataChanges()" value="{{description}}" placeholder="{{ description }}" class="form-control" id="project-description" rows="3"></textarea>
          </div>
          <button onclick="cancelChanges()" type="button" class="btn btn-outline-secondary">
            Cancel
          </button>
          <button type="button" disabled class="btn btn-success">
            Save
          </button>
        </form>
      </div>
    </div>
    <div class="tab-pane fade" id="project-config" role="tabpanel" aria-labelledby="project-config-tab">
      <div id="yamlComponent" class="p-2">
        <div id="yamlEditorDiv"></div>
      </div>
    </div>
    <div class="tab-pane fade" id="samples" role="tabpanel" aria-labelledby="samples-tab">
      <div id="csvComponent" class="p-2">
        <div id="csvEditorDiv">samples</div>
      </div>
    </div>
  </div>
</div>
<!-- state management -->
<script>
  // store the original values of the project
  {% if is_private is sameas true %}
      var originalIsPrivateValue = true
  {% elif is_private is sameas false %}
      var originalIsPrivateValue = false
  {% endif %}

  {% if description is not none %}
      var originalDesciriptionValue = "{{ description }}"
  {% else %}
      var originalDesciriptionValue = ""
  {% endif %}
  
  var originalProjectNameValue = "{{ project.name }}"

  // setters to reset the original values when the user saves
  const setOriginalIsPrivateValue = (val) => {
    originalIsPrivateValue = val
  }
  const setOriginalDescriptionValue = (val) => {
    originalDesciriptionValue = val
  }
  const setOriginalProjectNameValue = (val) => {
    originalProjectNameValue = val
  }

  // detect changes to the form
  const detectMetadataChanges = () => {
    const isPrivateToggle = document.getElementById("is-private-toggle")
    const projectDescription = document.getElementById("project-description")
    const projectName = document.getElementById("project-name")

    const saveButton = document.querySelector("button.btn-success")

    const isPrivateChanged = isPrivateToggle.checked !== originalIsPrivateValue
    const descriptionChanged = projectDescription.value !== originalDesciriptionValue
    const nameChanged = projectName.value !== originalProjectNameValue

    if (isPrivateChanged || descriptionChanged || nameChanged) {
      saveButton.disabled = false
    } else {
      saveButton.disabled = true
    }
  }

  // reset the values to the original values when the user cancels
  const cancelChanges = () => {
    document.getElementById("is-private-toggle").checked = originalIsPrivateValue
    document.getElementById("project-description").value = originalDesciriptionValue
    document.getElementById("project-name").value = originalProjectNameValue
    detectMetadataChanges()
  }

  const form = document.getElementById("metadata-form")
  form.addEventListener("change", detectMetadataChanges)
</script>
{% endblock %}